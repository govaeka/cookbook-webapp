-- MariaDB structure script for schema "cookbook"
-- best import using client command "source <path to this file>"

SET CHARACTER SET utf8mb4;
DROP DATABASE IF EXISTS cookbook;
CREATE DATABASE cookbook CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
USE cookbook;

-- define tables, sequences, indices, etc.
CREATE TABLE AbstractEntity (
	identity BIGINT NOT NULL AUTO_INCREMENT,
	discriminator ENUM("Document", "Person", "Recipe", "Ingredient", "Victual") NOT NULL,
	version INTEGER NOT NULL DEFAULT 1,
	created BIGINT NOT NULL,
	modified BIGINT NOT NULL,
	PRIMARY KEY (identity),
	KEY (discriminator)
);

CREATE TABLE Document (
	documentIdentity BIGINT NOT NULL,
	hash CHAR(64) NOT NULL,
	type VARCHAR(63) NOT NULL,
	description VARCHAR(127) NULL,
	content LONGBLOB NOT NULL,
	PRIMARY KEY (documentIdentity),
	FOREIGN KEY (documentIdentity) REFERENCES AbstractEntity (identity) ON DELETE CASCADE ON UPDATE CASCADE,
	UNIQUE KEY (hash)
);

CREATE TABLE Person (
	personIdentity BIGINT NOT NULL,
	avatarReference BIGINT NOT NULL,
	email CHAR(128) NOT NULL,
	passwordHash CHAR(64) NOT NULL,
	groupAlias ENUM("USER", "ADMIN") NOT NULL,
	title VARCHAR(15) NULL,
	surname VARCHAR(31) NOT NULL,
	forename VARCHAR(31) NOT NULL,
	postcode VARCHAR(15) NOT NULL,
	street VARCHAR(63) NOT NULL,
	city VARCHAR(63) NOT NULL,
	country VARCHAR(63) NOT NULL,
	PRIMARY KEY (personIdentity),
	FOREIGN KEY (personIdentity) REFERENCES AbstractEntity (identity) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (avatarReference) REFERENCES Document (documentIdentity) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE KEY (email)
);

CREATE TABLE Victual (
	victualIdentity BIGINT NOT NULL,
	avatarReference BIGINT NOT NULL,
	authorReference BIGINT NULL,
	diet ENUM("CARNIVORIAN", "PESCATARIAN", "LACTO_OVO_VEGETARIAN", "LACTO_VEGETARIAN", "VEGAN") NOT NULL,
	alias CHAR(128) NOT NULL,
	description VARCHAR(4094) NULL,
	PRIMARY KEY (victualIdentity),
	FOREIGN KEY (victualIdentity) REFERENCES AbstractEntity (identity) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (avatarReference) REFERENCES Document (documentIdentity) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (authorReference) REFERENCES Person (personIdentity) ON DELETE SET NULL ON UPDATE CASCADE,
	UNIQUE KEY (alias)
);

CREATE TABLE Recipe (
	recipeIdentity BIGINT NOT NULL,
	avatarReference BIGINT NOT NULL,
	authorReference BIGINT NULL,
	category ENUM ("MAIN_COURSE", "APPETIZER", "SNACK", "DESSERT", "BREAKFAST", "BUFFET", "BARBEQUE", "ADOLESCENT", "INFANT") NOT NULL,
	title CHAR(128) NOT NULL,
	description VARCHAR(4094) NULL,
	instruction VARCHAR(4094) NULL,
	PRIMARY KEY (recipeIdentity),
	FOREIGN KEY (recipeIdentity) REFERENCES AbstractEntity (identity) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (avatarReference) REFERENCES Document (documentIdentity) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (authorReference) REFERENCES Person (personIdentity) ON DELETE SET NULL ON UPDATE CASCADE,
	UNIQUE KEY (title)
);

CREATE TABLE Ingredient (
	ingredientIdentity BIGINT NOT NULL,
	recipeReference BIGINT NOT NULL,
	victualReference BIGINT NOT NULL,
	amount FLOAT NOT NULL,
	unit ENUM ("LITRE", "GRAM", "TEASPOON", "TABLESPOON", "PINCH", "CUP", "CAN", "TUBE", "BUSHEL", "PIECE") NOT NULL,
	PRIMARY KEY (ingredientIdentity),
	FOREIGN KEY (ingredientIdentity) REFERENCES AbstractEntity (identity) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (victualReference) REFERENCES Victual (victualIdentity) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (recipeReference) REFERENCES Recipe (recipeIdentity) ON DELETE CASCADE ON UPDATE CASCADE
);


-- NOT an entity: element collection
CREATE TABLE PhoneAssociation (
	personReference BIGINT NOT NULL,
	phone CHAR(16) NOT NULL,
	PRIMARY KEY (personReference, phone),
	FOREIGN KEY (personReference) REFERENCES Person (personIdentity) ON DELETE CASCADE ON UPDATE CASCADE
);

-- NOT an entity: many-to-many relationship association
CREATE TABLE RecipeIllustrationAssociation (
	recipeReference BIGINT NOT NULL,
	illustrationReference BIGINT NOT NULL,
	PRIMARY KEY (recipeReference, illustrationReference),
	FOREIGN KEY (recipeReference) REFERENCES Recipe (recipeIdentity) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (illustrationReference) REFERENCES Document (documentIdentity) ON DELETE CASCADE ON UPDATE CASCADE
);


-- define default avatar, ensuring it's ID is 1
INSERT INTO AbstractEntity VALUES (0, "Document", 1, UNIX_TIMESTAMP()*1000, UNIX_TIMESTAMP()*1000);
INSERT INTO Document VALUES (LAST_INSERT_ID(), "", "image/png", "default-icon.png", x'89504e470d0a1a0a0000000d49484452000000e1000000e10803000000096d224800000072504c5445ffffff87c24083c0387ebe2a85c13c82c0347fbe2df8fbf4fbfdf87cbd2482c03284c13aeaf4e0e8f3ddabd380e3f0d6b2d78bf2f8eca7d17ad4e8bfcce4b49dcc68bddc9d8dc54abbdb99a1ce6fa5d076dbeccadfeed0c2dfa4b3d78d92c75491c75398ca5fc8e2aed1e7bceff7e8c6e1ab77094fbc0000000174524e530040e6d86600000001624b47440088051d48000000097048597300000b1300000b1301009a9c180000000774494d4507e2011505242406df59a8000009734944415478daed5dd996aa3814cdbc1661100141451c4aebff7fb1b52e5d5d834424e724c1be7baddb0ffd50559be4cc4308f98bbf188365da9655bdcfb3ac288a2ccbf77555b6e9f215a85dda2e5f354c29a5a56437c41fff95525fff1f6b5679d75ee64a6ed11507ce956442d02108c1a4e2fc50748b99b12bf7477de346c7e1c6531ff7e54cd8a5dd89ebd1e4bed2d4fcd4a5c15fcd7dace4f3ec3e594a15ef03beb0bb9c2a466dc114cd77416acd3a564c500808a6e23a340d5b9db884a1f7ef75e5a72a207bbed61a925e4f52eb75183e419a2949712055e65fb7a69b28a67888a38d5f8ec98663f2fbe0c837893ff9db46d8fcfe9c63e1491ed7dc05bf3fe7b8f6611f84a4ee20856bdb911e95a02e21d4d1a9cad973b7fc3e383abcaa2d95d407246ddd10cc39f5059ebb90c046527f900dba34d61e24f0bb3476b804578afa865a61de501153ff8805da4dad94a02140a8eae574a81b9dba92341c6878615c1e190d09ec081c6f2442d0b0100bd0b071c1432378b38c8089d536408237950ae6a696110d131150a5e31c2ac12bc5f34b9f20d429b62113bc52b496c51da761835b5671d2d0095e295af9e14b46c307b3f16e1a310386a2b170b6e77084d7439cec866792ce03329b46f08dd3b980bfbda81ab554a8319d13e2095a069ea1b8827efc4360f8b4b6e900d3868249adb812cdf170b8fe3b369471a5650c4a543d99474dc08430968a165db9f8619693b62ba8d280e688273e4c7dacd5f63cdc19733917705d1ccf19fe1cc2120aa9368f839b72a5800e52eedd061442c7f53887f1b2e730aec513610680b293f499bc742d412e0d1ddd8260fdebd8d315a27d04208f72ed4a8ff2ed848cec413bd3a707cbafc9e4b4e449679f2f1187711526cbab32399659506bad3aaa2a6599bf5719990eebea8f10e86a46ed890d36125dd92cedd48cb62dec6d6c2f2a7f648433abdfc0eccb7a475b3df7404a122b7d669313fa2f2e15a816636b758411440b816d929d6df18cbd84693cb375fb8d8758d8c9395035cfd22d6685c1cbb7ba201caa60595aba8dd170449adb1ce1388f69144e9687386cb2ac7c5ff5d01bddbdefb322cbbbf691c95a583a8e7a384ab3fa720f54e44aa93f339652f1558b7a88b21ef8b976c6dea84877876fcd0e4235468ea5652435f0b5cf563fd69875fe1ddf0a6ef43d2c7d377d86bf1ac60cc2e6deb79326cd94db511477bdc70bc73242c57df96647c3adb6d435fc021e36c9e1ea4f35f4e9a42110b10dc3efe91acbb87031c10619fab65696feb7bca3cdedbeda705866b81b0627a1b3744eef7484d90586349a74df8673b8961ffc5e9868594cd393fed461fd74b14d69c6c0df6cd858ecd93447c8367baa76b0977498a15965a81d56f5eb97fb6dfbc9e4b4bc8b7cc7ca4bfffc8b6cbd79caa79dc570a073b265f8c37e75d6c5183d0031c1bd0261283bd89f37557e4f680c7ffc685fbd33880cbf0b4ea97d315ca1691aaacbd1460b11c39ac6be5782ed413f1874be81d8dfaa6f5eafb72644dd62796ddf3dc985b7b9c9c190a405f893be58c4775f67385ccaa901fea42f0e53e14dd10cd65337008d835f2297a32f45331ce443c88d38fab7f70d56d6fb87cd4f7d291a5d4d8b2a47ab9a1424158c92638519e8fcf46a6a4faa74b8f9a585b9559ffe44e647951ada1a80429dcf74949fd049c486a15ce0c8857a6118e1a5837f09ba1731e4ef86b16330c71ecec97d5ecded5dcc93f5051a1f7eb7a981710d77a77adfbb756f0ed9c9308d043896db0767ee0dbe8920a8deeb6bc16fae358da9346adf9cf84d18dea0efbdb50c921a5429f44e8de3349471f14a09abd7fbf83377ca909b9a8817c0c3ff7d2acfa55b2ab8a9732a815e65db3ba60e19c68d6901f28541bb8f3d4377591a630b0d59c26ff9e9333585ab7958b93176ef32f800202e9c9ea199e00e63cb4f7f868ee4d04c106734dea9a6311344da05d73374620f9951c99c90dcaade1ebaf0698c9318a5c6d275bd4fe322d5a60c7630c38bc07bbfd4416c6198d0bd606e7ced630bfcf850d7c3f12eea3ecd3e3e448ff187db11b00b0a7d87227a9e66b8057c89fcabfb3c0d76ae2ddea28de28dccb561e74b878b8439b68e934e72de86222176a2f633e78d5bb7901d5e53d0581587eb980e1a7bfc5cfb67ed09d5a919bea4f89ec667fd10d5e40ff7756dd023efcfe12054b32b2b17c9ed0101495df462a8d493b5a75ffb2f310d2fc76d2831aa80a3939e288e3563383a4b83ded73638f085af4adf9d5c188fc6e26bb7be7c4986da918f8f359df658d11cdcf479cb74f107bbddae2dcbb27aebea75be3950f4fcd7b7d64e4cbda6be406b2de5ed61e0d8c14b04df7af5c99c76954eb35327f172047f64873af9720c7fc4a50bf5720c7fce5ebfe019c22e31080fbfe2d2ddab5dd3dff3b7f18b318ca1e7f183bfa460cde3c15cd2167a2f46e89ad4e74c020ec1da6182361a00aa2b7c773f0d926fcab13625197dd215c29ea8a0180eec89c2f9955e1832c4b9cd20180ecf4fab1761a8b1768885c2d0b03731895e82619460ada00d84a171096dc25f80a1799130fc213a6768de238c2089ce19460f5e0f002fb4b966f8689fb7ed4e76ff0c1fee64079f8272cc70ccc66de08a825b86a31e6239ab19331cf7ea3a6c3396538623376ec39a7da70cc7bedb05aa6c5c321cbfd81fb25bc921c3f1ef3d813e023cc810fe9dda679e06de03ded398dd077819413ef5c44d33bf9af0930fa424f32bec3ff9fe21e81b964ef0ec1b96c093fff8609be79fd1107312c5316f75fd1ed8999328aa49af1455337ad3b92293f0f2ef72ff0fde569f89e1b77a0b6d19874f51c44b0b86c8239e200495e5636f8bd015aae115909168a3a00946004fa19521538c4a028073b814a3330141b0a7087382b08b0c41b528d87384c0891b38820b028894856617054b0928964d583e2a6b96041aab90220db92208c8c311469e1314548138a942550409a90841189948091e36fe938c6a4350d171bf3755f08e20236d7cea54d9a4041f1e752a960efde5a6523fc728694b5c61ed411a055f1387488f8e6da350c794b845255c5e55292ae21e6bee6a1a2c767b41bfc41b45e464a964542c892f245b8ecd91f16d427c22dda29e238bb629f18d2453583a47aa2c212160594b0d6f3b8496f5920483ea042c908c9f2a121692b55250d623566a9d9000d166b1b23f49a644d69260b1cb6325a7cba4902ace772470a4ef2b3585e5959d5abda7641e68d727ade4e802b288a5d2a7754be685c57bd170a5a569d98eb872d38a3745b72033457a5e17a786ddd60bdd560bdd9a2e3ffe2bafc49462cda9589f53f20258a66d59d5fb3ccb8aa2c8b27c5f57659b2ec95ffcc518fc03a579d9cf3d6d328d0000000049454e44ae426082');
UPDATE Document SET hash = SHA2(content,256) WHERE documentIdentity = LAST_INSERT_ID();
